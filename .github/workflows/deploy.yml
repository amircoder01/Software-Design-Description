name: Deploy to App Server via Bastion

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ HÃ¤mta koden
      uses: actions/checkout@v3

    - name: âš™ï¸ Installera .NET SDK
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x

    - name: ğŸ› ï¸ Bygg appen
      run: dotnet publish -c Release -o publish

    - name: ğŸ” Skapa SSH-nyckel
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

    - name: ğŸ” Tunnel via Bastion och deploy till App Server
      run: |
        echo "ğŸŒ Skapar tunnel till App Server via Bastion..."
        ssh -o StrictHostKeyChecking=no -f -N \
          -L 2223:${{ secrets.APP_PRIVATE_IP }}:22 \
          ${{ secrets.SSH_USERNAME }}@${{ secrets.BASTION_HOST }}

        echo "ğŸ“¦ Kopierar filer till App Server..."
        scp -P 2223 -r publish/* ${{ secrets.SSH_USERNAME }}@localhost:/home/${{ secrets.SSH_USERNAME }}/myapp/publish

        echo "ğŸš€ Startar om systemd-tjÃ¤n
